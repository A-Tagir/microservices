# Домашнее задание к занятию «Микросервисы: подходы»

## Задание 1

```
Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры. Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

Задача 1: Обеспечить разработку
Предложите решение для обеспечения процесса разработки: хранение исходного кода, непрерывная интеграция и непрерывная поставка. Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:

облачная система;
система контроля версий Git;
репозиторий на каждый сервис;
запуск сборки по событию из системы контроля версий;
запуск сборки по кнопке с указанием параметров;
возможность привязать настройки к каждой сборке;
возможность создания шаблонов для различных конфигураций сборок;
возможность безопасного хранения секретных данных (пароли, ключи доступа);
несколько конфигураций для сборки из одного репозитория;
кастомные шаги при сборке;
собственные докер-образы для сборки проектов;
возможность развернуть агентов сборки на собственных серверах;
возможность параллельного запуска нескольких сборок;
возможность параллельного запуска тестов.
Обоснуйте свой выбор.
```
## Решение

* Для обеспечения CI/CD есть несколько решений, которые мы изучали на прошлых лекциях по CI/CD

- Jenkins
- Teamcity
- GitLab

* Первые два решения не являются cloud-native системами, хотя и могут быть развернуты в облаке.
* Первые две системы могут быть интегрированы с Git (Jenkins через plugin, Teamcity имеет поддержку "из коробки")
GitLab построен на Git и его поддержка является native.
* В GitLab нет ограничений по репозиториям, кроме того в Jenkins вам приходится отдельно разграничивать доступ по репозиториям. В GitLab CI/CD  тем, кто совместно работает над проектом, вы можете назначать права, соответствующие их ролям. 
* GitLab CI/CD поддердживает запуск пайплайнов по событию в git, по расписанию, вручную и другие варианты;
* Gitlab имеет возможность привязать настройки к каждой сборке
* Gitlab имеет возможность возможность создания шаблонов для различных конфигураций сборок;
* Gitlab имеет встроенную возможность возможность безопасного хранения секретных данных, но можно подключить и внешние Vault;
* В GitLab есть поддержка несколько конфигураций для сборки из одного репозитория (настраивается в pipline);
* В GitLab можно добавлять кастомные шаги при сборке;
* В GitLab можно использовать собственные докер-образы для сборки проектов;
* В GitLab агенты сборки можно развернуть на собственных серверах или в облаке;
* В GitLab есть возможность параллельного запуска нескольких сборок;
* В GitLab есть возможность параллельного запуска тестов.

* Таким образов, наиболее подходящим и легким является GitLab, его и выберем.
Версия Community Edition бесплатная и подходит для целей задания, однако, может понадобится Enterprise, в случае, если нужна
работа с несколькими кластерами Kubernetes.

* Jenkins является все же более гибкой системой, хоть и требует больше опыта и знаний. В особых случаях имеет смысл выбрать его. Следует учитывать пожелания и опыт команды в конкретной компании.

## Задание 2

```
Предложите решение для обеспечения сбора и анализа логов сервисов в микросервисной архитектуре. Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:

сбор логов в центральное хранилище со всех хостов, обслуживающих систему;
минимальные требования к приложениям, сбор логов из stdout;
гарантированная доставка логов до центрального хранилища;
обеспечение поиска и фильтрации по записям логов;
обеспечение пользовательского интерфейса с возможностью предоставления доступа разработчикам для поиска по записям логов;
возможность дать ссылку на сохранённый поиск по записям логов.
Обоснуйте свой выбор.
```
## Решение
* В данном случае популярное и подходящее решение EKL-стек с для хранения, Beats и Logstash для сбора логов и Kibana для визуализации и анализа.
* Логи собираются в центральное хранилище Elasticsearch. В данном случае Logstash является агрегатором и собирает данные с beats агентов.
* Для гарантированной доставки логов следует использовать протокол TCP, кроме того logstash умеет Persistent Queue - хранит очередь сообщений на диске. Это поможет избежать потери информации при перезапуске logstash (но снизит производительность). 
* поиск и фильтрацию по записям логов обеспечивает Kibana
* Kibana предоставляет пользовательский интерфейс с возможностью предоставления доступа разработчикам для поиска по записям логов;
* Kibana предоставляет возможность дать ссылку на сохранённый поиск по записям логов.

## Задание 3

## Задача 3: Мониторинг
```
Предложите решение для обеспечения сбора и анализа состояния хостов и сервисов в микросервисной архитектуре. Решение может состоять из одного или нескольких программных продуктов и должно описывать способы и принципы их взаимодействия.

Решение должно соответствовать следующим требованиям:

сбор метрик со всех хостов, обслуживающих систему;
сбор метрик состояния ресурсов хостов: CPU, RAM, HDD, Network;
сбор метрик потребляемых ресурсов для каждого сервиса: CPU, RAM, HDD, Network;
сбор метрик, специфичных для каждого сервиса;
пользовательский интерфейс с возможностью делать запросы и агрегировать информацию;
пользовательский интерфейс с возможностью настраивать различные панели для отслеживания состояния системы.
Обоснуйте свой выбор.
```

## Решение

* По материалам прошлых лекций делаю выводы, что подходит вариант Prometheus для мониторинга и Grafana для визуализации.
* Для сбора метрик с хостов node_exporter
* Для сбора метрик приложений сервисов за NAT и firewall используем  pushgateway
* Для сбора метрик специфических сервисов используем модули (например nginx-exporter)
* Grafana позволяет визуализировать, настраивать dashboards и alerts.
Таким образом, данный стек отвечает требованиям задания.




